!function(e,t){"function"==typeof define&&define.amd?define(["leaflet"],e):"object"==typeof exports&&(module.exports=e(require("leaflet"))),"undefined"!=typeof t&&t.L&&(t.L.Control.MinZoomIndicator=e(L))}(function(e){var t=e.Control.extend({options:{},_layers:{},initialize:function(t){e.Util.setOptions(this,t),this._layers={}},_addLayer:function(e){var t=15;e.options.minZoom&&(t=e.options.minZoom),this._layers[e._leaflet_id]=t,this._updateBox(null)},_removeLayer:function(e){this._layers[e._leaflet_id]=null,this._updateBox(null)},_getMinZoomLevel:function(){var e,t=-1;for(e in this._layers)null!==this._layers[e]&&this._layers[e]>t&&(t=this._layers[e]);return t},_updateBox:function(t){var o=this._getMinZoomLevel();null!==t&&e.DomEvent.preventDefault(t),this._container.innerHTML=-1==o?this.options.minZoomMessageNoLayer:this.options.minZoomMessage.replace(/CURRENTZOOM/,this._map.getZoom()).replace(/MINZOOMLEVEL/,o),this._container.style.display=this._map.getZoom()>=o?"none":"block"},onAdd:function(t){return this._map=t,this._map.zoomIndicator=this,this._container=e.DomUtil.create("div","leaflet-control-minZoomIndicator"),this._map.on("moveend",this._updateBox,this),this._updateBox(null),this._container},onRemove:function(t){e.Control.prototype.onRemove.call(this,t),t.off({moveend:this._updateBox},this),this._map=null}});return t},window),function(e,t){"function"==typeof define&&define.amd?define(["leaflet"],e):"object"==typeof exports&&(module.exports=e(require("leaflet"))),"undefined"!=typeof t&&t.L&&(t.L.OverPassLayer=e(L))}(function(e){var t=require("js-clipper"),o=e.FeatureGroup.extend({options:{debug:!1,minZoom:15,endPoint:"http://overpass-api.de/api/",query:"(node({{bbox}})[organic];node({{bbox}})[second_hand];);out qt;",timeout:3e4,retryOnTimeout:!1,noInitialRequest:!1,beforeRequest:function(){},afterRequest:function(){},onSuccess:function(t){for(var o=0;o<t.elements.length;o++){var n,s,i,r=t.elements[o];r.id in this._ids||(this._ids[r.id]=!0,n="node"===r.type?new e.LatLng(r.lat,r.lon):new e.LatLng(r.center.lat,r.center.lon),s=this._getPoiPopupHTML(r.tags,r.id),i=e.circle(n,50,{color:"green",fillColor:"#3f0",fillOpacity:.5}).bindPopup(s),this.addLayer(i))}},onError:function(){},onTimeout:function(){},minZoomIndicatorOptions:{minZoomMessageNoLayer:"No layer assigned",minZoomMessage:"Current zoom Level: CURRENTZOOM. Data are visible at Level: MINZOOMLEVEL."}},initialize:function(t){e.Util.setOptions(this,t),this._ids={},this._loadedBounds=[],this._requestInProgress=!1},_getPoiPopupHTML:function(e,t){var o,n=document.createElement("a"),s=document.createElement("table"),i=document.createElement("div");n.href="http://www.openstreetmap.org/edit?editor=id&node="+t,n.appendChild(document.createTextNode("Edit this entry in iD")),s.style.borderSpacing="10px",s.style.borderCollapse="separate";for(var r in e)o=s.insertRow(0),o.insertCell(0).appendChild(document.createTextNode(r)),o.insertCell(1).appendChild(document.createTextNode(e[r]));return i.appendChild(n),i.appendChild(s),i},_buildRequestBox:function(t){return e.rectangle(t,{bounds:t,color:"blue",weight:1,opacity:.5,fillOpacity:.1,clickable:!1})},_addRequestBox:function(e){return this._requestBoxes.addLayer(e)},_getRequestBoxes:function(){return this._requestBoxes.getLayers()},_removeRequestBox:function(e){this._requestBoxes.removeLayer(e)},_removeRequestBoxes:function(){return this._requestBoxes.clearLayers()},_addResponseBox:function(e){return this._responseBoxes.addLayer(e)},_addResponseBoxes:function(e){{var t=this;e.length}this._removeRequestBoxes(),e.forEach(function(e){e.setStyle({color:"black",weight:2}),t._addResponseBox(e)})},_isFullyLoadedBounds:function(e,o){if(0===o.length)return!1;var n,s=this._buildClipsFromBounds([e]),i=this._buildClipsFromBounds(o),r=new t.Clipper,u=new t.PolyTree;return r.AddPaths(s,t.PolyType.ptSubject,!0),r.AddPaths(i,t.PolyType.ptClip,!0),r.Execute(t.ClipType.ctDifference,u,t.PolyFillType.pftNonZero,t.PolyFillType.pftNonZero),n=t.JS.PolyTreeToExPolygons(u),0===n.length?!0:!1},_getLoadedBounds:function(e){return this._loadedBounds},_setLoadedBounds:function(e){this._loadedBounds.push(e)},_buildClipsFromBounds:function(e){var t=[];return e.forEach(function(e){t.push([{X:1e6*e._southWest.lng,Y:1e6*e._southWest.lat},{X:1e6*e._southWest.lng,Y:1e6*e._northEast.lat},{X:1e6*e._northEast.lng,Y:1e6*e._northEast.lat},{X:1e6*e._northEast.lng,Y:1e6*e._southWest.lat}])}),t},_buildBoundsFromClips:function(t){var o=[];return t.forEach(function(t){o.push(new e.LatLngBounds(new e.LatLng(t[0].Y/1e6,t[0].X/1e6),new e.LatLng(t[2].Y/1e6,t[2].X/1e6)))}),o},_buildOverpassQueryFromQueryAndBounds:function(e,t){var o=t._southWest,n=t._northEast,s=[o.lat,o.lng,n.lat,n.lng].join(",");return e.replace(/(\{\{bbox\}\})/g,s)},_buildOverpassUrlFromEndPointAndQuery:function(e,t){return e+"interpreter?data=[out:json];"+t},_buildLargerBounds:function(e){var t=Math.abs(e._northEast.lng-e._southWest.lng),o=Math.abs(e._northEast.lat-e._southWest.lat);return e._southWest.lat-=o/2,e._southWest.lng-=t/2,e._northEast.lat+=o/2,e._northEast.lng+=t/2,e},_setRequestInProgress:function(e){this._requestInProgress=e},_isRequestInProgress:function(){return this._requestInProgress},_hasNextRequest:function(){return this._nextRequest?!0:!1},_getNextRequest:function(e){return this._nextRequest},_setNextRequest:function(e){this._nextRequest=e},_removeNextRequest:function(){this._nextRequest=null},_prepareRequest:function(){if(this._map.getZoom()<this.options.minZoom)return!1;var e=this._buildLargerBounds(this._map.getBounds()),t=this._buildOverpassUrlFromEndPointAndQuery(this.options.endPoint,this._buildOverpassQueryFromQueryAndBounds(this.options.query,e)),o=this._sendRequest.bind(this,t,e);this._isRequestInProgress()?this._setNextRequest(o):(this._removeNextRequest(),o())},_sendRequest:function(e,t){var o=this._getLoadedBounds();if(this._isFullyLoadedBounds(t,o))return void this._setRequestInProgress(!1);var n=this,s=new XMLHttpRequest,i=this.options.beforeRequest();return i===!1?void this.options.afterRequest():(this._setRequestInProgress(!0),this.options.debug&&this._addRequestBox(this._buildRequestBox(t)),s.open("GET",e,!0),s.timeout=this.options.timeout,s.ontimeout=function(){n._onRequestTimeout(this,e,t)},s.onload=function(){n._onRequestLoad(this,t)},void s.send())},_onRequestLoad:function(e,t){e.status>=200&&e.status<400?(this.options.onSuccess(JSON.parse(e.response)),this._onRequestLoadCallback(t)):(this._onRequestErrorCallback(t),this.options.onError(e)),this._onRequestCompleteCallback(t)},_onRequestTimeout:function(e,t,o){this.options.onTimeout(e),this.options.retryOnTimeout?this._sendRequest(t):(this._onRequestErrorCallback(o),this._onRequestCompleteCallback(o))},_onRequestLoadCallback:function(e){this._setLoadedBounds(e),this.options.debug&&this._addResponseBoxes(this._getRequestBoxes())},_onRequestErrorCallback:function(e){this.options.debug&&this._removeRequestBox(this._buildRequestBox(e))},_onRequestCompleteCallback:function(e){if(this.options.afterRequest(),this._hasNextRequest()){var t=this._getNextRequest();this._removeNextRequest(),t()}else this._setRequestInProgress(!1)},onAdd:function(t){this._map=t,this._map.zoomIndicator?(this._zoomControl=this._map.zoomIndicator,this._zoomControl._addLayer(this)):(this._zoomControl=new e.Control.MinZoomIndicator(this.options.minZoomIndicatorOptions),this._map.addControl(this._zoomControl),this._zoomControl._addLayer(this)),this.options.debug&&(this._requestBoxes=e.featureGroup().addTo(this._map),this._responseBoxes=e.featureGroup().addTo(this._map)),this.options.noInitialRequest||this._prepareRequest(),-1!==this.options.query.indexOf("({{bbox}})")&&this._map.on("moveend",this._prepareRequest,this)},onRemove:function(t){e.LayerGroup.prototype.onRemove.call(this,t),this._ids={},this._loadedBounds=[],this._requestInProgress=!1,this._zoomControl._removeLayer(this),t.off("moveend",this.onMoveEnd,this),this._map=null},getData:function(){return this._data}});return o},window);