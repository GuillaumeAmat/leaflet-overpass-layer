L.Control.MinZoomIndicator=L.Control.extend({options:{},_layers:{},initialize:function(t){L.Util.setOptions(this,t),this._layers={}},_addLayer:function(t){var e=15;t.options.minZoom&&(e=t.options.minZoom),this._layers[t._leaflet_id]=e,this._updateBox(null)},_removeLayer:function(t){this._layers[t._leaflet_id]=null,this._updateBox(null)},_getMinZoomLevel:function(){var t,e=-1;for(t in this._layers)null!==this._layers[t]&&this._layers[t]>e&&(e=this._layers[t]);return e},_updateBox:function(t){var e=this._getMinZoomLevel();null!==t&&L.DomEvent.preventDefault(t),this._container.innerHTML=-1==e?this.options.minZoomMessageNoLayer:this.options.minZoomMessage.replace(/CURRENTZOOM/,this._map.getZoom()).replace(/MINZOOMLEVEL/,e),this._container.style.display=this._map.getZoom()>=e?"none":"block"},onAdd:function(t){return this._map=t,this._map.zoomIndicator=this,this._container=L.DomUtil.create("div","leaflet-control-minZoomIndicator"),this._map.on("moveend",this._updateBox,this),this._updateBox(null),this._container},onRemove:function(t){L.Control.prototype.onRemove.call(this,t),t.off({moveend:this._updateBox},this),this._map=null}}),L.OverPassLayer=L.FeatureGroup.extend({options:{debug:!1,minZoom:15,endPoint:"http://overpass-api.de/api/",query:"(node({{bbox}})[organic];node({{bbox}})[second_hand];);out qt;",timeout:3e4,retryOnTimeout:!1,noInitialRequest:!1,beforeRequest:function(){},afterRequest:function(){},onSuccess:function(t){for(var e=0;e<t.elements.length;e++){var o,n,s,i=t.elements[e];i.id in this.instance._ids||(this.instance._ids[i.id]=!0,o="node"===i.type?new L.LatLng(i.lat,i.lon):new L.LatLng(i.center.lat,i.center.lon),n=this.instance._getPoiPopupHTML(i.tags,i.id),s=L.circle(o,50,{color:"green",fillColor:"#3f0",fillOpacity:.5}).bindPopup(n),this.instance.addLayer(s))}},onError:function(){},onTimeout:function(){},minZoomIndicatorOptions:{minZoomMessageNoLayer:"No layer assigned",minZoomMessage:"Current zoom Level: CURRENTZOOM. Data are visible at Level: MINZOOMLEVEL."}},initialize:function(t){L.Util.setOptions(this,t),this._layers={},this._ids={},this._requested={}},_getPoiPopupHTML:function(t,e){var o,n=document.createElement("a"),s=document.createElement("table"),i=document.createElement("div");n.href="http://www.openstreetmap.org/edit?editor=id&node="+e,n.appendChild(document.createTextNode("Edit this entry in iD")),s.style.borderSpacing="10px",s.style.borderCollapse="separate";for(var r in t)o=s.insertRow(0),o.insertCell(0).appendChild(document.createTextNode(r)),o.insertCell(1).appendChild(document.createTextNode(t[r]));return i.appendChild(n),i.appendChild(s),i},_buildRequestBox:function(t){return L.rectangle(t,{bounds:t,color:"blue",weight:1,opacity:.5,fillOpacity:.1,clickable:!1})},_addRequestBox:function(t){return this._requestBoxes.addLayer(t)},_getRequestBoxes:function(){return this._requestBoxes.getLayers()},_removeRequestBox:function(t){this._requestBoxes.removeLayer(t)},_removeRequestBoxes:function(){return this._requestBoxes.clearLayers()},_addResponseBox:function(t){return this._responseBoxes.addLayer(t)},_addResponseBoxes:function(t){{var e=this;t.length}this._removeRequestBoxes(),t.forEach(function(t){t.setStyle({color:"black"}),e._addResponseBox(t)})},_buildXFromLng:function(t,e){return Math.floor((t+400)/1100*Math.pow(2,e))},_buildYFromLat:function(t,e){return Math.floor((1-Math.log(Math.tan(t*Math.PI/400)+1/Math.cos(t*Math.PI/400))/Math.PI)/2*Math.pow(2,e))},_buildLngFromX:function(t,e){return t/Math.pow(2,e)*1100-400},_buildLatFromY:function(t,e){var o=Math.PI-2*Math.PI*t/Math.pow(2,e);return 400/Math.PI*Math.atan(.5*(Math.exp(o)-Math.exp(-o)))},_getBoundsListFromCoordinates:function(t,e,o,n){for(var s,i,r,a,u=14,d=this._buildXFromLng(t,u),h=this._buildXFromLng(o,u),l=this._buildYFromLat(n,u),_=this._buildYFromLat(e,u),p=[],m=d;h>=m;m++)for(var c=l;_>=c;c++)a=Math.round(1e6*this._buildLngFromX(m,u))/1e6,i=Math.round(1e6*this._buildLngFromX(m+1,u))/1e6,s=Math.round(1e6*this._buildLatFromY(c,u))/1e6,r=Math.round(1e6*this._buildLatFromY(c+1,u))/1e6,p.push(new L.LatLngBounds(new L.LatLng(r,a),new L.LatLng(s,i)));return p},_getXYFromBounds:function(t){return{x:t._southWest.lng,y:t._northEast.lat}},_buildOverpassQueryFromQueryAndBounds:function(t,e){var o=e._southWest,n=e._northEast,s=[o.lat,o.lng,n.lat,n.lng].join(",");return t.replace(/(\{\{bbox\}\})/g,s)},_buildOverpassUrlFromEndPointAndQuery:function(t,e){return t+"interpreter?data=[out:json];"+e},_isRequestedArea:function(t){var e=this._getXYFromBounds(t);return e.x in this._requested&&e.y in this._requested[e.x]&&this._requested[e.x][e.y]===!0?!0:!1},_setRequestedArea:function(t){var e=this._getXYFromBounds(t);e.x in this._requested||(this._requested[e.x]={}),this._requested[e.x][e.y]=!0},_removeRequestedArea:function(t){var e=this._getXYFromBounds(t);delete this._requested[e.x]},_prepareRequest:function(){if(this._map.getZoom()<this.options.minZoom)return!1;for(var t,e=this,o=!0,n=this._getBoundsListFromCoordinates(this._map.getBounds()._southWest.lng,this._map.getBounds()._southWest.lat,this._map.getBounds()._northEast.lng,this._map.getBounds()._northEast.lat),s=n.length,i=function(){0===--s&&(this.options.afterRequest.call(e),this.options.debug&&this._addResponseBoxes(this._getRequestBoxes()))},r=function(t,e){this.options.debug&&this._removeRequestBox(e),this._removeRequestedArea(t)},a=0;a<n.length;a++)if(bounds=n[a],this._isRequestedArea(bounds))s--;else{if(this._setRequestedArea(bounds),this.options.debug&&(box=this._buildRequestBox(bounds),this._addRequestBox(box)),o){var u=this.options.beforeRequest.call(this);if(u===!1)return void this.options.afterRequest.call(this);o=!1}t=this._buildOverpassUrlFromEndPointAndQuery(this.options.endPoint,this._buildOverpassQueryFromQueryAndBounds(this.options.query,bounds)),this.options.debug?this._sendRequest(t,i.bind(this),r.bind(this,bounds,box)):this._sendRequest(t,i.bind(this),r.bind(this,bounds))}},_sendRequest:function(t,e,o){var n=this,s={instance:this};request=new XMLHttpRequest,request.open("GET",t,!0),request.timeout=this.options.timeout,request.ontimeout=function(){n.options.onTimeout.call(s,this),n.options.retryOnTimeout?n._sendRequest(t,e,o):(o(),e())},request.onload=function(){this.status>=200&&this.status<400?n.options.onSuccess.call(s,JSON.parse(this.response)):(o(),n.options.onError.call(s,this)),e()},request.send()},onAdd:function(t){this._map=t,this._map.zoomIndicator?(this._zoomControl=this._map.zoomIndicator,this._zoomControl._addLayer(this)):(this._zoomControl=new L.Control.MinZoomIndicator(this.options.minZoomIndicatorOptions),this._map.addControl(this._zoomControl),this._zoomControl._addLayer(this)),this.options.debug&&(this._requestBoxes=L.featureGroup().addTo(this._map),this._responseBoxes=L.featureGroup().addTo(this._map)),this.options.noInitialRequest||this._prepareRequest(),-1!==this.options.query.indexOf("({{bbox}})")&&this._map.on("moveend",this._prepareRequest,this)},onRemove:function(t){L.LayerGroup.prototype.onRemove.call(this,t),this._ids={},this._requested={},this._zoomControl._removeLayer(this),t.off("moveend",this.onMoveEnd,this),this._map=null},getData:function(){return this._data}});